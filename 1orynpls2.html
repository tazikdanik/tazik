<script>
  // --- –•—Ä–∞–Ω–∏–ª–∏—â–µ ---
  const KEY = "hw_leaderboard_v1";

  // data = [{id, name, score, streak}]
  let data = load();

  // --- –≠–ª–µ–º–µ–Ω—Ç—ã ---
  const nameInput = document.getElementById("nameInput");
  const addBtn = document.getElementById("addBtn");
  const demoBtn = document.getElementById("demoBtn");
  const resetBtn = document.getElementById("resetBtn");
  const tbody = document.getElementById("tbody");
  const statsPill = document.getElementById("statsPill");
  const toast = document.getElementById("toast");

  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const jsonBox = document.getElementById("jsonBox");

  // --- –£—Ç–∏–ª–∏—Ç—ã ---
  function uid() {
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function normalizeName(s) {
    return (s || "").trim().replace(/\s+/g, " ");
  }

  function save() {
    localStorage.setItem(KEY, JSON.stringify(data));
    showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ");
  }

  function load() {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return [];

      return arr
        .filter(x => x && typeof x.name === "string" && typeof x.score === "number")
        .map(x => ({
          id: x.id || uid(),
          name: x.name,
          score: Math.max(0, Math.floor(x.score)),
          streak: Math.max(0, Math.floor(x.streak || 0))
        }));
    } catch (e) {
      return [];
    }
  }

  function showToast(text) {
    toast.textContent = text;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toast.classList.remove("show"), 1200);
  }

  function totalScores() {
    return data.reduce((sum, x) => sum + x.score, 0);
  }

  function escapeHtml(str) {
    return str
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // --- –†–µ–Ω–¥–µ—Ä ---
  function render() {
    // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: score desc, –∑–∞—Ç–µ–º name asc
    const sorted = [...data].sort((a, b) => {
      if (b.score !== a.score) return b.score - a.score;
      return a.name.localeCompare(b.name, "ru");
    });

    // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    statsPill.textContent = `üë©‚Äçüéì ${sorted.length} —É—á–µ–Ω–∏–∫–æ–≤ ¬∑ ‚úÖ ${totalScores()} –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π`;

    // —Ç–∞–±–ª–∏—Ü–∞
    tbody.innerHTML = "";
    if (sorted.length === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="rank">‚Äî</td>
        <td colspan="3" style="color:#a9b6d8">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å —É—á–µ–Ω–∏–∫–∞ —Å–ª–µ–≤–∞ üôÇ</td>
      `;
      tbody.appendChild(tr);
      return;
    }

    sorted.forEach((s, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="rank">#${idx + 1}</td>
        <td class="name">${escapeHtml(s.name)}</td>
        <td class="score">${s.score}</td>
        <td>
          <div class="actions">
            <button class="btn ok" type="button" onclick="handleAction('plus','${s.id}')">+1</button>
            <button class="btn bad" type="button" onclick="handleAction('minus','${s.id}')">-1</button>
            <button class="btn" type="button" onclick="handleAction('del','${s.id}')">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // --- –õ–æ–≥–∏–∫–∞ ---
  function addStudent(name) {
    name = normalizeName(name);
    if (!name) return showToast("–í–≤–µ–¥–∏ –∏–º—è üôÇ");

    if (data.some(x => x.name.toLowerCase() === name.toLowerCase())) {
      return showToast("–¢–∞–∫–æ–π —É—á–µ–Ω–∏–∫ —É–∂–µ –µ—Å—Ç—å");
    }

    data.push({ id: uid(), name, score: 0, streak: 0 });
    save();
    render();
    nameInput.value = "";
    nameInput.focus();
  }

  // +1 / -1 –∏ –±–æ–Ω—É—Å +5 –∑–∞ 3 –ø–æ–¥—Ä—è–¥
  function changeScore(id, delta) {
    const s = data.find(x => x.id === id);
    if (!s) return;

    if (typeof s.streak !== "number") s.streak = 0;

    if (delta > 0) {
      s.score += 1;
      s.streak += 1;

      if (s.streak === 3) {
        s.score += 5;
        s.streak = 0;
        alert("üî• –ë–æ–Ω—É—Å +5 –∑–∞ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å!");
      }
    } else {
      s.score = Math.max(0, s.score - 1);
      s.streak = 0; // —Å–±—Ä–æ—Å —Å–µ—Ä–∏–∏ –µ—Å–ª–∏ –º–∏–Ω—É—Å
    }

    save();
    render();
  }

  function removeStudent(id) {
    data = data.filter(x => x.id !== id);
    save();
    render();
  }

  // --- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π (–¥–ª—è onclick) ---
  window.handleAction = function (act, id) {
    if (act === "plus") changeScore(id, +1);
    if (act === "minus") changeScore(id, -1);

    if (act === "del") {
      const s = data.find(x => x.id === id);
      const ok = confirm(`–£–¥–∞–ª–∏—Ç—å "${s ? s.name : "—É—á–µ–Ω–∏–∫–∞"}"?`);
      if (ok) removeStudent(id);
    }
  };

  // --- –°–æ–±—ã—Ç–∏—è ---
  addBtn.addEventListener("click", () => addStudent(nameInput.value));
  nameInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") addStudent(nameInput.value);
  });

  demoBtn.addEventListener("click", () => {
    const samples = ["—É—á–µ–Ω–∏–∫1", "—É—á–µ–Ω–∏–∫2", "—É—á–µ–Ω–∏–∫3", "—É—á–µ–Ω–∏–∫4"];
    samples.forEach(n => {
      if (!data.some(x => x.name.toLowerCase() === n.toLowerCase())) {
        data.push({ id: uid(), name: n, score: 0, streak: 0 });
      }
    });
    save();
    render();
  });

  resetBtn.addEventListener("click", () => {
    const ok = confirm("–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë? –î–∞–Ω–Ω—ã–µ —É–¥–∞–ª—è—Ç—Å—è –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞.");
    if (!ok) return;
    data = [];
    localStorage.removeItem(KEY);
    showToast("–°–±—Ä–æ—à–µ–Ω–æ üßπ");
    render();
  });

  exportBtn.addEventListener("click", () => {
    jsonBox.value = JSON.stringify(data, null, 2);
    showToast("–≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤ ‚úÖ");
  });

  importBtn.addEventListener("click", () => {
    try {
      const arr = JSON.parse(jsonBox.value || "[]");
      if (!Array.isArray(arr)) throw new Error("JSON –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º");

      const cleaned = arr
        .filter(x => x && typeof x.name === "string")
        .map(x => ({
          id: x.id || uid(),
          name: normalizeName(x.name),
          score: Math.max(0, Math.floor(Number(x.score || 0))),
          streak: Math.max(0, Math.floor(Number(x.streak || 0)))
        }))
        .filter(x => x.name.length > 0);

      // —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏–º—ë–Ω
      const seen = new Set();
      data = cleaned.filter(x => {
        const key = x.name.toLowerCase();
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });

      save();
      render();
      showToast("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ");
    } catch (err) {
      showToast("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ ‚ùå");
      alert("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JSON:\n" + err.message);
    }
  });

  // --- –°—Ç–∞—Ä—Ç ---
  render();
</script>